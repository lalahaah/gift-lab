# **3\. 기프트랩(Gift Lab) 기능 요구사항 명세서 (FRD)**

| 문서 버전 | 작성일 | 작성자 | 상태 |  
| v1.0 | 2026-01-05 | Next Engine | 승인 완료 |

## **1\. 개요 (Introduction)**

### **1.1. 목적**

본 문서는 **기프트랩(Gift Lab)** 모바일 애플리케이션(MVP) 개발을 위한 기능적/비기능적 요구사항을 정의한다. 기획서(PRD)에 기술된 사용자 경험을 구현하기 위해 프론트엔드(Flutter)와 백엔드(Supabase)가 수행해야 할 구체적인 로직을 명시한다.

### **1.2. 범위 (Scope)**

* **Client:** Flutter 기반 Android/iOS 앱.  
* **Server:** Supabase (Auth, Database, Edge Functions).  
* **AI:** OpenAI API (gpt-4o-mini).  
* **Monetization:** Google AdMob, Coupang Partners (Search Landing).

## **2\. 시스템 아키텍처 (System Architecture)**

* **Client (App):** UI 렌더링, 사용자 입력 수집, 딥링크 실행, 광고 SDK 로드.  
* **Middleware (Edge Function):** 클라이언트 요청 수신 → 프롬프트 조합 → OpenAI 호출 → JSON 파싱 → 클라이언트 반환.  
* **Database (PostgreSQL):** 추천 이력 및 클릭 로그 비동기 저장.

## **3\. 상세 기능 요구사항 (Functional Requirements)**

### **FR-01. 사용자 인증 및 초기화**

* **FR-01-01 (익명 로그인):**  
  * 앱 최초 실행 시, 별도의 회원가입 절차 없이 Supabase Auth의 signInAnonymously()를 호출하여 고유 User ID (UUID)를 발급받아야 한다.  
  * 발급된 토큰은 로컬 스토리지에 저장하여 재실행 시 세션을 유지해야 한다.  
* **FR-01-02 (약관 동의):**  
  * 최초 진입 시 '이용약관' 및 '개인정보처리방침' 동의 팝업을 노출하지 않고, 설정 메뉴 내에 배치하여 UX 장벽을 제거한다. (단, 앱 스토어 심사 기준에 따라 가입 화면이 없으므로 '설정' 내 명시 필수)

### **FR-02. 선물 의뢰 입력 (Onboarding Form)**

* **FR-02-01 (단계별 입력):**  
  * 총 5단계의 입력 폼은 PageView로 구현하며, 각 단계에서 '다음' 버튼 클릭 시 유효성 검사(Validation)를 수행한다.  
  * **Step 3 (MBTI):** E/I, N/S, F/T, P/J 4개의 토글 버튼으로 구성하며, '모름' 선택 시 빈 값(null) 처리가 아닌 '성격 키워드(태그)' 선택을 강제해야 한다.  
  * **Step 4 (예산):** Slider 위젯을 사용하며, 최소 1만원 \~ 최대 50만원(구간: 1만원 단위)으로 설정한다. 50만원 초과 시 '50만원 이상'으로 표시한다.  
* **FR-02-02 (데이터 저장):**  
  * 최종 '분석 요청' 버튼 클릭 시, 입력된 모든 데이터는 Map\<String, dynamic\> 형태로 상태 관리(Riverpod) 객체에 임시 저장된다.

### **FR-03. AI 분석 및 결과 생성 (Core Logic)**

* **FR-03-01 (Edge Function 호출):**  
  * 클라이언트는 입력 데이터를 Payload로 담아 Supabase Edge Function (analyze-gift)을 POST 방식으로 호출한다.  
* **FR-03-02 (프롬프트 주입):**  
  * 서버는 사전에 정의된 'System Prompt'와 사용자 입력값을 결합한다.  
  * **필수 제약 조건:** "쿠팡 검색이 용이한 키워드 포함", "브랜드명 명시", "JSON 포맷 응답".  
* **FR-03-03 (응답 파싱):**  
  * OpenAI 응답은 반드시 JSON이어야 하며, 파싱 실패 시(JSON 깨짐 등) 최대 1회 재시도(Retry) 로직을 수행한다.  
  * 재시도 실패 시, 사전에 준비된 'Fallback(기본 추천) 데이터'를 반환하여 에러 화면 노출을 방지한다.

### **FR-04. 결과 화면 및 수익화 연동**

* **FR-04-01 (전면 광고 \- Interstitial):**  
  * Edge Function 호출 직후 로딩 화면 진입 시, AdMob Interstitial Ad를 백그라운드에서 로드(Load)한다.  
  * AI 응답 수신 완료 시점(약 3\~5초 후)에 전면 광고를 show() 한다.  
  * 사용자가 광고를 닫는 이벤트(onAdDismissedFullScreenContent) 발생 시 결과 페이지로 이동한다.  
* **FR-04-02 (쿠팡 딥링크 실행):**  
  * '최저가 확인하기' 버튼 클릭 시 아래 우선순위로 URL을 실행한다.  
  * **Priority 1 (App):** coupang://search?q={search\_keyword} (쿠팡 앱이 설치된 경우)  
  * **Priority 2 (Web):** https://www.coupang.com/np/search?q={search\_keyword} (앱 미설치 시)  
  * Android(intent)와 iOS(UrlLauncher)의 스키마 처리 방식을 분기 처리한다.

### **FR-05. 데이터 로깅 (Data Logging)**

* **FR-05-01 (클릭 로그):**  
  * 사용자가 상품 링크를 클릭하는 순간, click\_logs 테이블에 user\_id, product\_name, keyword, timestamp를 INSERT 한다. (Fire-and-forget 방식: 응답 대기 안 함).

## **4\. 비기능 요구사항 (Non-Functional Requirements)**

### **NFR-01. 성능 (Performance)**

* **응답 속도:** AI 분석 요청 후 결과 수신까지 **10초 이내**를 목표로 한다. (gpt-4o-mini 기준).  
* **광고 로딩:** 전면 광고는 입력 폼의 마지막 단계(Step 4\~5) 진입 시 미리 프리로드(Preload)하여 대기 시간을 최소화한다.

### **NFR-02. 안정성 (Stability)**

* **네트워크 예외:** 오프라인 상태에서 앱 실행 시 "네트워크 연결을 확인해주세요" 스낵바를 노출하고 재시도 버튼을 제공한다.  
* **API 비용 제어:** Edge Function 내에 속도 제한(Rate Limit)을 두어, 특정 IP에서의 어뷰징(무한 요청)을 차단한다.

## **5\. 데이터베이스 스키마 요구사항 (DB Schema)**

### **5.1. Tables**

Table: gift\_requests  
| Column | Type | Description |  
| :--- | :--- | :--- |  
| id | UUID | Primary Key |  
| user\_id | UUID | Foreign Key (auth.users) |  
| relation | Text | 관계 (연인, 부모님 등) |  
| event\_type | Text | 기념일 종류 |  
| mbti\_code | Text | MBTI (예: ESTJ) |  
| budget\_range | Text | 예산 범위 |  
| created\_at | Timestamptz | 생성 일시 |  
Table: recommendations  
| Column | Type | Description |  
| :--- | :--- | :--- |  
| id | UUID | Primary Key |  
| request\_id | UUID | Foreign Key (gift\_requests) |  
| product\_name | Text | 추천 상품명 |  
| search\_keyword | Text | 쿠팡 검색 키워드 |  
| ai\_reason | Text | 추천 이유 |

## **6\. 개발 제약 사항 (Constraints)**

* **언어:** Dart (Flutter 3.x 이상).  
* **배포 타겟:** Android (min SDK 21), iOS (target 14.0).  
* **외부 라이브러리:**  
  * google\_mobile\_ads: AdMob 연동.  
  * supabase\_flutter: 백엔드 연동.  
  * url\_launcher: 딥링크 처리.  
  * flutter\_riverpod: 상태 관리.